# 로드 밸런싱 (L4 vs L7)

로드 밸런서는 “어떤 서버로 요청을 보낼지” 결정하는 핵심 장치다. 계층(L4/L7)에 따라 역할이 크게 달라지므로, 아래 순서대로 이해하자.

---

## 1. L4 vs L7 개념 잡기
- **L4 Load Balancer**
  - 전송 계층(TCP/UDP)에서 동작.
  - IP/포트(5-튜플)로만 판단해 매우 빠르다.
  - SSL/TLS를 건드리지 않고 그대로 전달(Pass-through)하는 경우가 많다.
- **L7 Load Balancer**
  - 애플리케이션 계층(HTTP/HTTPS)에서 동작.
  - URL, Header, 쿠키, JWT 등 비지니스 컨텍스트로 라우팅.
  - SSL 종료(Offloading), 인증, WAF, A/B 테스트 같은 부가 기능을 제공.

---

## 2. 비교 표

| 항목 | L4 | L7 |
| --- | --- | --- |
| 처리 속도 | 매우 빠름 | 상대적으로 느림 |
| 라우팅 조건 | IP/포트, 세션 정보 | 경로, 헤더, 쿠키, Geo, JWT |
| 기능 | 단순 분배, Health Check | 인증, WAF, Rate Limit, Canary Test |
| SSL 처리 | 대부분 Pass-through | Termination/Offloading 가능 |
| 적용 예 | 게임 서버, TCP 기반 프로토콜, DB Proxy | 웹/API, 멀티 테넌트 BFF, API Gateway |

---

## 3. 어떤 구조를 선택할까?
- **L4 단독**: 단순 TCP 서비스(게임, 금융 FIX 등)로 초고속 분배가 필요할 때.
- **L7 단독**: 인증/인가, 요청 변환, 멀티 테넌트 지원이 필요한 API 서비스.
- **혼합(L4 → L7)**: 전 세계 트래픽을 L4(DNS LB)에서 1차 분산 후, 리전 내부에서 L7로 정책 기반 라우팅. DDoS 방어 계층과 애플리케이션 정책 계층을 분리할 수 있다.

---

## 4. 다이어그램 예시

```
[사용자]
   │
   ▼
[L4 LB] ──Health Check→ 여러 AZ/Region
   │
   ▼
[L7 LB / API Gateway]
   │              ├─ 인증/인가
   │              ├─ Rate Limit
   │              └─ A/B 테스트
   ▼
[서비스 풀] → [DB/캐시]
```

다이어그램을 직접 그려보면, 어떤 계층에서 어떤 정책을 적용할지 명확해진다.

---

## 5. 설계/운영 체크리스트
- [ ] 서비스 특성에 맞는 LB 계층(L4/L7 혹은 혼합)을 정의했는가?
- [ ] Health Check 엔드포인트, 탐지 주기, 실패 허용 횟수를 설정했는가?
- [ ] 세션 스티키/쿠키 기반 라우팅이 필요한지 여부를 판단했는가?
- [ ] 장애 시 Failover, Auto Scaling, 설정 일관성(Config Drift) 검증을 자동화했는가?
- [ ] SSL 오프로딩, WAF, DDoS 보호, Geo Routing 등 부가 기능 요구사항을 문서화했는가?
- [ ] Observability(요청 성공률, 지연, Health Check 실패, LB 자원 사용량)를 모니터링하고 있는가?

---

## 6. 실습 아이디어
- **실습 1**: 클라우드 로드 밸런서(ELB/ALB, GCLB 등)로 L4/L7 각각 구성해보고 로그/지연을 비교.
- **실습 2**: 세션 스티키 설정을 켜고/끄면서 사용자 경험 차이를 확인.
- **실습 3**: 배포 중 일부 서버를 강제로 종료해 Failover가 정상 동작하는지 점검.

---

## 7. 운영 팁
- 고가용성을 위해 **이중화(Active-Active/Active-Standby)**와 **IaC 기반 설정 버저닝**을 필수로 한다.
- 롤링 업데이트 시 로드 밸런서 Drain 기능을 사용해 연결을 안전하게 종료한다.

