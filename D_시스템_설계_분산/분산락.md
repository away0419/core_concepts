# 분산 락(Distributed Lock)

여러 노드가 공유 자원을 동시에 수정할 때 충돌을 방지하기 위해 분산 락이 필요하다. 이 문서는 구현 방식과 주의사항을 설명한다.

---

## 1. 구현 방식
- **Redis 기반**: `SET key value NX PX`로 잠금, 만료 시간 설정. Redlock 알고리즘으로 다중 노드 신뢰성 강화.
- **ZooKeeper/etcd**: ZNode/Key를 이용해 락을 획득하고 세션이 끊어지면 자동 해제.
- **데이터베이스**: `SELECT ... FOR UPDATE`, advisory lock, 락 테이블.

---

## 2. 설계 시 고려사항
- **만료 시간**: 너무 길면 교착, 너무 짧으면 아직 작업이 끝나지 않았는데 락이 풀릴 수 있음.
- **재진입 가능 여부**: 동일 클라이언트가 다시 락을 잡아야 할 때 토큰을 재사용할지.
- **장애 처리**: 클라이언트가 죽었을 때 자동으로 락이 해제되는지 확인.
- **공정성(Fairness)**: 요청 순서를 보장해야 하는지 여부.

---

## 3. 체크리스트
- [ ] 락을 획득한 주체를 구분할 수 있는 토큰/UUID를 사용하고 있는가?
- [ ] 만료 시간 + 연장(Heartbeat) 메커니즘을 구현했는가?
- [ ] 락 실패 시 재시도 전략과 대기 시간을 정의했는가?
- [ ] 장애 시 락이 풀리지 않는 경우를 탐지하는 모니터링을 갖고 있는가?

---

## 4. 실습 아이디어
- **실습 1**: Redis로 분산 락을 구현하고, 동일 자원을 여러 인스턴스가 동시에 업데이트하도록 테스트.
- **실습 2**: ZooKeeper/etcd로 락을 잡고 세션을 강제로 종료해 자동 해제가 되는지 확인.
- **실습 3**: Redlock 알고리즘을 구현해 단일 Redis 장애 시에도 안전한지 검증.

