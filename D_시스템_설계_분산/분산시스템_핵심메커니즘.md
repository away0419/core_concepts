# 분산 시스템 핵심 메커니즘 모음

분산 시스템을 구성할 때 반복적으로 등장하는 개념들을 한 문서에 묶었다: 분산 트랜잭션, 리더 선출, 분산 ID, 이벤트 소싱, 메시지 큐, 분산 캐시, 서비스 디스커버리, 레이트 리미팅.

---

## 1. 분산 트랜잭션
- **2PC (Two-Phase Commit)**: Prepare/Commit 단계로 구성. 강한 일관성, 지연/락 증가.
- **SAGA**: 각 단계가 로컬 트랜잭션을 수행하고, 실패 시 보상(Compensation) 실행. Eventually Consistent.
- **TCC (Try-Confirm/Cancel)**: 리소스를 예약(Try) 후 확정(Confirm) 또는 취소(Cancel).

## 2. 리더 선출
- ZooKeeper/etcd/Raft를 이용해 리더 한 명을 뽑아 조율.
- 리더가 정기적으로 Heartbeat를 보내고, 끊기면 새로운 리더를 선출.

## 3. 분산 ID 생성
- **Snowflake**: 타임스탬프 + 데이터센터 ID + 노드 ID + 시퀀스.
- **UUID**: 충돌 확률이 낮음, 순서 보장 필요 시 ULID/KSUID 사용.

## 4. 이벤트 소싱
- 상태를 직접 저장하지 않고 이벤트 로그만 저장.
- 리플레이(Replay)로 현재 상태를 재구성, 감사/감사 로그 용이.
- 단점: 이벤트 스키마 버전 관리와 스냅샷이 필요.

## 5. 메시지 큐 & 스트림
- Kafka, RabbitMQ, Pulsar. 생산자/소비자 결합도를 낮춘다.
- 오프셋 관리, 재처리, DLQ 설계가 필수.

## 6. 분산 캐시
- Redis Cluster, Memcached Sharding. Consistent Hashing 사용.
- 캐시 일관성, 재해 복구, Warm-up 전략 필요.

## 7. 서비스 디스커버리
- Eureka, Consul, etcd, Kubernetes Service. 서비스 위치/IP를 동적으로 등록/조회.
- 헬스체크, TTL 갱신, DNS 기반 디스커버리 조합.

## 8. 레이트 리미팅
- 토큰 버킷, 슬라이딩 윈도우, Leaky Bucket.
- Edge(공격 차단), Gateway(API 보호), 각 서비스 내부에서 다단계로 적용.

---

## 9. 체크리스트
- [ ] 분산 트랜잭션 패턴을 비즈니스 특성에 맞게 선택했는가?
- [ ] 리더 선출/분산 ID/이벤트 소싱 등 공통 기능을 플랫폼화했는가?
- [ ] 메시지 큐/캐시/디스커버리/레이트리밋에 대한 모니터링과 운영 Runbook을 갖고 있는가?

---

## 10. 실습 아이디어
- **실습 1**: Saga 패턴으로 주문-결제-재고 프로세스를 구현하고 실패 시 보상 트랜잭션을 실행.
- **실습 2**: etcd로 리더 선출을 구현하고, 리더 장애 시 Failover가 되는지 확인.
- **실습 3**: Snowflake ID 생성기를 구현해 다중 인스턴스에서 충돌 여부를 테스트.

